<!-- this is mainly for data that needs to be loaded when the page is loaded -->
<script>
    //-------------------------------------//
    // Fix jQuery CSFR Code Issue - 1 of 2 //
    //-------------------------------------//
    // Note: https://docs.djangoproject.com/en/1.8/ref/csrf/
    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    $(document).ready(function () {
        //-------------------------------------//
        // Fix jQuery CSFR Code Issue - 2 of 2 //
        //-------------------------------------//
        // Note: https://docs.djangoproject.com/en/1.8/ref/csrf/
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                }
            }
        });
                      
        ajax_refresh_table(); // Refresh the table for the first time.
              
        // The following code will poll the server every 10 seconds to see if
        // we have the latest data.
        window.setInterval(function(){
            ajax_refresh_table();
        }, 5000);
    });
    
    /**
     *  Makes a JSON call to our API service to fetch all the open cart sessions
     *  we have under this employee.
     */
    function ajax_refresh_table() {
        //////////
        // LIST //
        //////////
        var url = "/api/receipts/?has_finished=False&employee={{ employee.employee_id }}";
        jQuery.ajax({
            url: url,
            cache: false,
            contentType: false,
            processData: false,
            type: 'GET',
            success: function(result){
                // Take the JSON results and generate a HTML table from it.
                generate_table(result);
            },
            error: function(xhr,status,error) {
                console.debug(status + ': ' + error + ' -- ' + xhr.responseText);
                alert(xhr.responseText);
            },
            complete: function(xhr,status) {
                
            }
        });
    }

    /**
     *  Renders a table listing all the open cart sessions in our system.
     */
    function generate_table(result)
    {
        // Debugging code
        //var json_text = JSON.stringify(result, null, 2);
        //var obj = JSON.parse(json_text);
    
        var html = '<div class="table-responsive">';
        html += '<h2>Open Sessions</h2>';
        html += '<table class="table table-striped">';
        html += '<thead>';
        html += '<tr>';
        html += '<th>Receipt ID #</th>';
        html += '<th>Function</th>';
        html += '</tr>';
        html += '</thead>';
        html += '<tbody>';
        
        $(result).each(function(iter,val){
            var receipt_id = val['receipt_id'];
            var url = "/inventory/{{ org.org_id }}/{{ store.store_id }}/checkout/" + receipt_id +"/customer";
            html += '<tr>';
            html += '<td>' + receipt_id + '</td>';
            html += '<td>' + '<button type="button" class="btn btn-labeled btn-success" style="font-size: 23pt;margin-left: auto;margin-right: auto;" onclick="window.location=\'' + url +'\'"><span class="btn-label"><i class="fa fa-shopping-cart"></i></span>Continue Existing Checkout</button>' + '</td>';
            html += '</tr>';
        });
        html += '</tbody></table></div>';
        $('#id_table_placeholder').html(''); // Clear Table
        $(html).appendTo('#id_table_placeholder'); // Load Table.
    }

    /**
     *  Create a new cart by submitting an API call to create a new cart where
     *  the web-service will create the new cart and return the newly created
     *  cart object. This function will take the newly created object and load
     *  up the processing UI based on the 'cart_id'.
     */
    function open_new_cart()
    {
        ////////////
        // INSERT //
        ////////////
        var data = new FormData();
        data.append('format', 'json');
        data.append('organization', '{{ org.org_id }}');
        data.append('store', '{{ store.store_id }}');
        data.append('employee', '{{ employee.employee_id }}');
        data.append('customer', '');
        data.append('payment_method', '1');
        data.append('has_purchased_online', 'false');
        data.append('has_tax', 'true');
        data.append('tax_rate', '{{ store.tax_rate }}');
        data.append('tax_amount', '0');
        data.append('has_finished', 'false');
        data.append('has_paid', 'false');
        data.append('sub_total', '0');
        data.append('discount_amount', '0');
        data.append('total_amount', '0');
        data.append('status', '1');
        data.append('billing_name', '');
        data.append('billing_address', '');
        data.append('billing_email', '');
        data.append('billing_phone', '');
        data.append('billing_city', '');
        data.append('billing_province', '');
        data.append('billing_country', '');
        data.append('billing_postal', '');
        data.append('shipping_name', '');
        data.append('shipping_address', '');
        data.append('shipping_email', '');
        data.append('shipping_phone', '');
        data.append('shipping_city', '');
        data.append('shipping_province', '');
        data.append('shipping_country', '');
        data.append('shipping_postal', '');
        
        var url = "/api/receipts/";
        
        jQuery.ajax({
            url: url,
            data: data,
            cache: false,
            contentType: false,
            processData: false,
            type: 'POST',
            success: function(json_result){
                var receipt_id = json_result['receipt_id'];
                window.location="/inventory/{{ org.org_id }}/{{ store.store_id }}/checkout/"+receipt_id+"/customer";
            },
            error: function(xhr,status,error) {
                console.debug(status + ': ' + error + ' -- ' + xhr.responseText);
                alert(xhr.responseText);
            },
            complete: function(xhr,status) {
                    
            }
        });
    }
</script>