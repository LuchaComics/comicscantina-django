{% load staticfiles %}
<!-- this is mainly for data that needs to be loaded when the page is loaded -->
<script>
    $(document).ready(function() { // Run the following when the page loads up..
        ajax_refresh_table(); // Refresh the table for the first time.
              
        // The following code will poll the server every 10 seconds to see if
        // we have the latest data.
        window.setInterval(function(){
            ajax_refresh_table();
        }, 5000);
    });
    
    /**
     *  Makes a JSON call to our API service to fetch all the open cart sessions
     *  we have under this employee.
     */
    function ajax_refresh_table() {
        var url = "/api/carts/?is_closed=False&employee={{ employee.employee_id }}";
        jQuery.ajax({
            url: url,
            cache: false,
            contentType: false,
            processData: false,
            type: 'GET',
            success: function(result){
                // Take the JSON results and generate a HTML table from it.
                generate_table(result);
            },
            error: function(xhr,status,error) {
                console.debug(status + ': ' + error + ' -- ' + xhr.responseText);
            },
            complete: function(xhr,status) {
                
            }
        });
    }

    /**
     *  Renders a table listing all the open cart sessions in our system.
     */
    function generate_table(result)
    {
        // Debugging code
        //var json_text = JSON.stringify(result, null, 2);
        //var obj = JSON.parse(json_text);
    
        var html = '<div class="table-responsive">';
        html += '<h2>Open Sessions</h2>';
        html += '<table class="table table-striped">';
        html += '<thead>';
        html += '<tr>';
        html += '<th>Cart ID #</th>';
        html += '<th>Function</th>';
        html += '</tr>';
        html += '</thead>';
        html += '<tbody>';
        
        $(result).each(function(iter,val){
            var url = "/inventory/{{ org.org_id }}/{{ store.store_id }}/checkout/" + val['cart_id'] +"/customer";
            html += '<tr>';
            html += '<td>' + val['cart_id'] + '</td>';
            html += '<td>' + '<button type="button" class="btn btn-labeled btn-success" style="font-size: 23pt;margin-left: auto;margin-right: auto;" onclick="window.location=\'' + url +'\'"><span class="btn-label"><i class="fa fa-shopping-cart"></i></span>Continue Existing Checkout</button>' + '</td>';
            html += '</tr>';
        });
        html += '</tbody></table></div>';
        $('#id_table_placeholder').html(''); // Clear Table
        $(html).appendTo('#id_table_placeholder'); // Load Table.
    }

    /**
     *  Create a new cart by submitting an API call to create a new cart where
     *  the web-service will create the new cart and return the newly created
     *  cart object. This function will take the newly created object and load
     *  up the processing UI based on the 'cart_id'.
     */
    function open_new_cart()
    {
        var data = new FormData();
        data.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        data.append('format', 'json');
        data.append('employee', '{{ employee.employee_id }}');
        data.append('customer', '');
        data.append('is_closed', 'false');
        
        var url = "/api/carts/";
        
        jQuery.ajax({
            url: url,
            data: data,
            cache: false,
            contentType: false,
            processData: false,
            type: 'POST',
            success: function(json_result){
                var cart_id = json_result['cart_id'];
                window.location="/inventory/{{ org.org_id }}/{{ store.store_id }}/checkout/"+cart_id+"/customer";
            },
            error: function(xhr,status,error) {
                    console.debug(status + ': ' + error + ' -- ' + xhr.responseText);
            },
            complete: function(xhr,status) {
                    
            }
        });
    }
</script>