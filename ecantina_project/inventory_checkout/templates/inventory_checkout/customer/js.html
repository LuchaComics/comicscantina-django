<!-- this is mainly for data that needs to be loaded when the page is loaded -->
<input type="hidden" id="nav_tracker" value="2" />
<script>
    //-------------------------------------//
    // Fix jQuery CSFR Code Issue - 1 of 2 //
    //-------------------------------------//
    // Note: https://docs.djangoproject.com/en/1.8/ref/csrf/
    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }
    
    $(document).ready(function () {
        //-------------------------------------//
        // Fix jQuery CSFR Code Issue - 2 of 2 //
        //-------------------------------------//
        // Note: https://docs.djangoproject.com/en/1.8/ref/csrf/
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                }
            }
        });
           
        // Check to see if this receipt has already been processed.
        // If it already has then leave UI.
        if ('{{ receipt.has_finished }}' == 'True') {
            window.location='/inventory/{{ org.org_id }}/{{ store.store_id }}/checkout';
        }
                      
        // The remaineder of the code loads up the UI.
        $('.customer-select li').on('click', function () {
            var option = $(this).find('a').data('option');
                                    
            $('.tab.selected').removeClass('selected');
                                    
            $(this).addClass('selected');
                                                  
            if (option == 'New Customer') {
                $('#nav_tracker').val("2"); // Update nav tracker
                $('#return-customer-info-panel').slideUp();
                $('#scan-customer-card-panel').slideUp();
                $('#new-customer-info-panel').slideDown();
            }
            else if (option == 'Returning Customer') {
                $('#nav_tracker').val("3"); // Update nav tracker
                $('#new-customer-info-panel').slideUp();
                $('#scan-customer-card-panel').slideUp();
                $('#return-customer-info-panel').slideDown();
            }
            else if(option == 'Scan Card') {
                $('#nav_tracker').val("4"); // Update nav tracker
                $('#new-customer-info-panel').slideUp();
                $('#return-customer-info-panel').slideUp();
                $('#scan-customer-card-panel').slideDown();
            }
            else {
                $('#nav_tracker').val("1"); // Update nav tracker
                $('#return-customer-info-panel').slideUp();
                $('#new-customer-info-panel').slideUp();
                $('#scan-customer-card-panel').slideUp();
            }
        });
                      
        // the list options holding the autocomplete stuff
        // that should be loaded as the user types with relevant
        // options will hold the customer_id as a data attribute...
        // when selected and the text box value changes, we will load
        // up the customer's information using their id and then fill in
        // the other text fields
        // this is where we handle autocomplete
        $('#txt-searchfname').on('change', function () {
            $('#txt-searchlname').val('Doe');
            $('#txt-searchemail').val('test@email.com');
        });
                      
        // this is where we handle autocomplete
        $('#txt-searchlname').on('change', function () {
            $('#txt-searchfname').val('John');
            $('#txt-searchemail').val('test@email.com');
        });
                      
        // this is where we handle autocomplete
        $('#txt-searchemail').on('change', function () {
            $('#txt-searchfname').val('John');
            $('#txt-searchlname').val('Doe');
        });
                      
        // The following code will poll the server every 10 seconds to see if
        // we have the latest data.
        window.setInterval(function(){
            background_card_scanner();
        }, 5000);
    });
    
    /**
     *  Function will detect what customer was inputted and attempt to save 
     *  the customer for the cart; afterwords, it will proceed to
     *  load up the next screen.
     */
    function scan_cart_items_load()
    {
        var selected = $('#nav_tracker').val();
        if (selected == "1")
        {
            handle_guest_customer();
        }
        else if (selected == "2")
        {
            handle_new_customer();
        }
        else if (selected == "3")
        {
            handle_returning_customer();
        }
        else if (selected == "4")
        {
            handle_scan_customer();
        }
    }

    /**
     *  Function will simply load up the next page.
     */
    function handle_guest_customer()
    {
        load_checkout_page(); // Simply load the next page.
    }

    /**
     *  Function will save the new customer and load up the next page.
     */
    function handle_new_customer()
    {
        /////////////////////
        // INSERT CUSTOMER //
        /////////////////////
        var data = new FormData();
        data.append('format', 'json');
        data.append('email', $('#id_email').val());
        data.append('name', $('#id_name').val());
        data.append('phone', $('#id_phone').val());
        data.append('street_number', $('#id_street_number').val());
        data.append('street_name', $('#id_street_name').val());
        data.append('unit_number', $('#id_unit_number').val());
        data.append('city', $('#id_city').val());
        data.append('country', $('#id_country').val());
        data.append('province', $('#id_province').val());
        data.append('postal', $('#id_postal').val());
        data.append('first_name', $('#id_first_name').val());
        data.append('last_name', $('#id_last_name').val());
        data.append('has_consented', $('#id_has_consented').is(':checked'));

        var url = "/api/customers/";
        
        jQuery.ajax({
            url: url,
            data: data,
            cache: false,
            contentType: false,
            processData: false,
            type: 'POST',
            success: function(json_result){
                ////////////////////
                // UPDATE Receipt //
                ////////////////////
                // Extract the "customer_id" value.
                var customer_id = json_result['customer_id'];
                    
                // Create the cart object.
                var data2 = new FormData();
                data2.append('format', 'json');
                data2.append('employee', '{{ receipt.employee_id }}');
                data2.append('receipt_id', '{{ receipt.receipt_id }}');
                data2.append('is_closed', 'false');
                data2.append('customer', customer_id);
                    
                var url2 = "/api/receipts/{{ receipt.receipt_id }}/";
                    
                jQuery.ajax({
                    url: url2,
                    data: data2,
                    cache: false,
                    contentType: false,
                    processData: false,
                    type: 'PUT',
                    success: function(json_result){
                        // Extract "receipt_id" and load up the next page.
                        var receipt_id = json_result['receipt_id'];
                        window.location="/inventory/{{ org.org_id }}/{{ store.store_id }}/checkout/"+receipt_id+"/items";
                        },
                    error: function(xhr,status,error) {
                        console.debug(status + ': ' + error + ' -- ' + xhr.responseText);
                        alert(xhr.responseText);
                    },
                    complete: function(xhr,status) {
                            
                    }
                }); // End Cart jQuery
                
            },
            error: function(xhr,status,error) {
                console.debug(status + ': ' + error + ' -- ' + xhr.responseText);
                alert(xhr.responseText);
            },
                complete: function(xhr,status) {
            
            }
        }); // End Customer jQuery.
    }

    /**
     *  Function will load up the next page.
     */
    function handle_returning_customer()
    {
        load_checkout_page(); // Simply load the next page.
    }

    /**
     *  Function will set the "customer_id" for the cart.
     */
    function update_cart_by_set_customer_id(customer_id)
    {
        /////////////////
        // UPDATE CART //
        /////////////////
        var data = new FormData();
        data.append('format', 'json');
        data.append('employee', '{{ receipt.employee_id }}');
        data.append('cart_id', '{{ receipt.receipt_id }}');
        data.append('is_closed', 'false');
        data.append('customer', customer_id);
    
        var url = "/api/receipts/{{ receipt.receipt_id }}/";
    
        jQuery.ajax({
            url: url,
            data: data,
            cache: false,
            contentType: false,
            processData: false,
            type: 'PUT',
            success: function(json_result){
                // alert("Saved"); // Debugging Purposes Only
            },
            error: function(xhr,status,error) {
                console.debug(status + ': ' + error + ' -- ' + xhr.responseText);
                alert(xhr.responseText);
            },
            complete: function(xhr,status) {
                
            }
        }); // End Cart jQuery
    }

    /**
     *  Function will simply load up the next page.
     */
    function handle_scan_customer()
    {
        load_checkout_page(); // Simply load the next page.
    }

    /**
     *  Function will cause the browser to move to the next page.
     */
    function load_checkout_page()
    {
        window.location = "/inventory/{{ org.org_id }}/{{ store.store_id }}/checkout/{{ receipt.receipt_id }}/items";
    }

    function print_customer_card()
    {
        alert("TODO");
    }

    /**
     *  Function will search through all the customers depending on the search
     *  criteria and return the results in a table for the employee to choose 
     *  from.
     */
    function customer_lookup()
    {
        // Get the criteria to search by.
        var email = $('#id_email2').val();
        var phone = $('#id_phone2').val();
        var first_name = $('#id_first_name2').val();
        var last_name = $('#id_last_name2').val();
        var postal = $('#id_postal2').val();
        
        // Generate the search URL.
        var url = "/api/customers/";
        url += "?postal=";
        if (postal != '') {
            url += postal;
        }
        
        url += "&email=";
        if (email != '') {
            url += email;
        }
        
        url += "&phone=";
        if (phone != '') {
            url += phone;
        }
        
        url += "&first_name=";
        if (first_name != '') {
            url += first_name;
        }
        
        url += "&last_name=";
        if (last_name != '') {
            url += last_name;
        }
        
        //////////
        // LIST //
        //////////
        jQuery.ajax({
            url: url,
            cache: false,
            contentType: false,
            processData: false,
            type: 'GET',
            success: function(result){
                // Take the JSON results and generate a HTML table from it.
                generate_search_results_table(result);
            },
            error: function(xhr,status,error) {
                console.debug(status + ': ' + error + ' -- ' + xhr.responseText);
                alert(xhr.responseText);
            },
            complete: function(xhr,status) {
                    
            }
        });
    }

    /**
     *  Renders a table listing all the open cart sessions in our system.
     */
    function generate_search_results_table(result)
    {
        // Debugging code
        //var json_text = JSON.stringify(result, null, 2);
        //var obj = JSON.parse(json_text);
    
        var html = '<div class="table-responsive">';
        html += '<table class="table table-striped">';
        html += '<thead>';
        html += '<tr>';
        html += '<th>First Name</th>';
        html += '<th>Last Name</th>';
        html += '<th>Email</th>';
        html += '<th>Phone</th>';
        html += '<th>Select</th>';
        html += '</tr>';
        html += '</thead>';
        html += '<tbody>';
    
        $(result).each(function(iter,val){
            html += '<tr>';
            html += '<td>' + val['first_name'] + '</td>';
            html += '<td>' + val['last_name'] + '</td>';
            html += '<td>' + val['email'] + '</td>';
            html += '<td>' + val['phone'] + '</td>';
            html += '<td style="text-align:center;">';
            html += '<div class="radio c-radio">';
            html += '<label>';
            html += '<input name="selected-customer" value="custid-1" checked="" type="radio" onclick="update_cart_by_set_customer_id(' + val['customer_id'] +');">';
            html += '<span class="fa fa-circle"></span></label>';
            html += '</div>';
            html += '</td>';
            html += '</tr>';
        });
        html += '</tbody></table></div>';
        $('#id_table_placeholder').html(''); // Clear Table
        $(html).appendTo('#id_table_placeholder'); // Load Table.
    }

    /**
     *  Function is to be called continously be jQuery. This function polls
     *  the cart and checks to see if the "customer_id" has been set. If not
     *  a loading type animation will play.
     */
    function background_card_scanner()
    {
        /////////
        // GET //
        /////////
        var url = "/api/receipts/{{ receipt.receipt_id }}/";
        jQuery.ajax({
            url: url,
            cache: false,
            contentType: false,
            processData: false,
            type: 'GET',
            success: function(result){
                // Detect non-empty "customer_id".
                if (result['customer_id'] != '')
                {
                    // To give the appearance of new card scanned. Only display
                    // the message if the current customer_id of the cart is
                    // different then what was scanned.
                    if ( result['customer_id'] == $('#current_customer_id').val() ) {
                        $('#id_scanner_response').html('<p><i>Customer Successfully Assigned</i></p>');
                    }
                }
            },
            error: function(xhr,status,error) {
                console.debug(status + ': ' + error + ' -- ' + xhr.responseText);
                alert(xhr.responseText);
            },
            complete: function(xhr,status) {
                
            }
        });
    }
</script>