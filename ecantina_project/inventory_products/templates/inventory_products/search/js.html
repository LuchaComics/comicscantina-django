{% load staticfiles %}
{% include 'api/issue.html' %}
{% include 'api/series.html' %}
{% include 'api/product.html' %}
<!-- this is mainly for data that needs to be loaded when the page is loaded -->
<script>
    //-------------------------------------//
    // Fix jQuery CSFR Code Issue - 1 of 2 //
    //-------------------------------------//
    // Note: https://docs.djangoproject.com/en/1.8/ref/csrf/
    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    $(document).ready(function () {
        //-------------------------------------//
        // Fix jQuery CSFR Code Issue - 2 of 2 //
        //-------------------------------------//
        // Note: https://docs.djangoproject.com/en/1.8/ref/csrf/
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                }
            }
        });
        
        // DYNAMIC SEARCHING (AKA AJAX SEARCHING)
        // The following code will provide all the necessary functions
        // which allow dynamic searching of comic books...
        //
        // Whenever user starts typing a textbox, start dynamically
        // making ajax calls to look up the results.
        var thread = null;
                      
        function lookupProducts() {
            var name =  $('#id_name').val();
            var brand =  $('#id_brand').val();
            var category =  $('#id_category').val();
            var tags =  $('#id_tags').val();
            var min_price =  $('#id_min_price').val();
            var max_price =  $('#id_max_price').val();
                      
            // Call our application and return results.
            ajax_search_products(name, brand, category, tags, min_price, max_price);
        }
                      
        $('#id_name').keyup(function() {
            clearTimeout(thread);
            thread = setTimeout(function() { lookupProducts(); }, 500);
        });
        $('#id_brand').keyup(function() {
            clearTimeout(thread);
            thread = setTimeout(function() { lookupProducts(); }, 500);
        });
        $('#id_category').keyup(function() {
            clearTimeout(thread);
            thread = setTimeout(function() { lookupProducts(); }, 500);
        });
        $('#id_tags').keyup(function() {
            clearTimeout(thread);
            thread = setTimeout(function() { lookupProducts(); }, 500);
        });
        $('#id_min_price').keyup(function() {
            clearTimeout(thread);
            thread = setTimeout(function() { lookupProducts(); }, 500);
        });
        $('#id_max_price').keyup(function() {
            clearTimeout(thread);
            thread = setTimeout(function() { lookupProducts(); }, 500);
        });
    });
    
    function ajax_search_products(name, brand, category, tags, min_price, max_price)
    {
        var arr = Array();
        
        if (name.length > 0) {
            arr.push({ 'name': name });
        }
        if (brand.length > 0) {
            arr.push({ 'brand_name': brand });
        }
        if (category.length > 0) {
            arr.push({ 'category_name': category });
        }
        if (min_price.length > 0) {
            arr.push({ 'min_price': min_price });
        }
        if (max_price.length > 0) {
            arr.push({ 'max_price': max_price });
        }
        if (tags.length > 0) {
            var tags_arr = tags.split(",");
            for (var i = 0; i < tags_arr.length; i++) {
                arr.push({ 'tag': tags_arr[i] });
            }
        }
        
        filter_products(arr, function(json_objects) {
            generate_table(json_objects);
        });
        
    }

    function generate_table(json_result)
    {
        // Debugging code
        //var json_text = JSON.stringify(json_result, null, 2);
        //var obj = JSON.parse(json_text);
        //console.log(obj)
    
        // Initial Code
        var html = '';
        html += '<div class="product-listing m-lg">';
        html += '<div class="product-type-listing clearfix">';
        html += '<div class="products-list">';
    
        $(json_result).each(function(iter,val2){
            var position_index = 0;
            $(val2['results']).each(function(iter2,val){
                var product_id = val['product_id'];
                position_index += 1;
                html += '<div class="col-sm-6 col-md-3 col-lg-2 product-item add clearfix" ';
                html += 'data-position="'+position_index+'" data-product-id="'+product_id+'">';
                                                
                // Load "Missing Cover" image if there is no cover image,
                // else display the cover.
                var image_url = val['image_url'];
                if (image_url == null || image_url == "")
                {
                    var url = '{% static "inventory/img/missing_cover.png" %}';
                    html += '<img class="product-image center-block" width="100" alt="product-title" src="'+url+'" />';
                }
                else
                {
                    html += '<img class="product-image center-block" width="100" alt="product-title" src="'+image_url+'" />';
                }
                                                
                html += '<div class="product-item-details">';
                html += '<h4 class="comic-issue product-title m-sm center-block text-center">'+val['name']+'</h4>';
                html += '<span class="center-block comic-date text-muted text-center">$'+val['price']+'</span>';
                html += '<label style=";margin-top:2px;margin-left:auto;margin-right:auto;text-align:center;width:100%;">&nbsp;&nbsp;</label>';
                html += '</div>';
                html += '</div>';
            });
        });
        html += '</div>';
        html += '</div>';
        html += ' <div class="clearfix"></div>';
        html += '</div>';
        $('#id_table_placeholder').html(''); // Clear Table
        $(html).appendTo('#id_table_placeholder'); // Load Table.
    }

</script>