{% load staticfiles %}
{% include 'api/imageupload.html' %}
{% include 'api/section.html' %}
{% include 'api/comic.html' %}
{% include 'api/product.html' %}
<!-- this is mainly for data that needs to be loaded when the page is loaded -->
<script>
    //-------------------------------------//
    // Fix jQuery CSFR Code Issue - 1 of 2 //
    //-------------------------------------//
    // Note: https://docs.djangoproject.com/en/1.8/ref/csrf/
    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    $(document).ready(function () {
        //-------------------------------------//
        // Fix jQuery CSFR Code Issue - 2 of 2 //
        //-------------------------------------//
        // Note: https://docs.djangoproject.com/en/1.8/ref/csrf/
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                }
            }
        });
                      
        // If we are to edit the product, make sure we load all the tags
        // associated with this product.
        ajax_populate_tags();
   
                      
        // Initialize the UI.
        $('#id_section').prop("disabled", true);
        $('#id_label_colour').prop("disabled", true);
        $('#id_cgc_rating_ui').hide();
                      
        // When the user clicks the 'Store', the 'Sections' will get filtered
        // down to the specific location.
        $('#id_store').on('change', function(){
            var store_id = $(this).val();
            if (store_id > 0)
            {
                $('#id_section').prop("disabled", false);
                ajax_load_section_dropdown(store_id);
            }
        });
                      
        // this changes the options available in the condition rating dropdown
        $('#id_is_cgc_rated').on('click', function(){
            if( $(this).is(':checked') ){
                //alert("Checked"); // Debugging Purposes Only
                $('#id_label_colour').prop("disabled", false);
                $('#id_cgc_rating_ui').show();
                $('#id_condition_rating_ui').hide();
            }
            else {
                //alert("unchecked"); // Debugging Purposes Only
                $('#id_label_colour').prop("disabled", true);
                $("#id_label_colour").val($("#target option:first").val());
                $("#id_condition_rating").val($("#target option:first").val());
                $('#id_condition_rating_ui').show();
                $('#id_cgc_rating_ui').hide();
            }
        });
                      
        // When the 'Add' button was selected for the tag.
        $('body').on('click', '.item-tag-table button.btn-success.btn-add', function(){
            // Extract these values from the tag.
            var tag_id = $('#sel-item-tag').val();
            var name = $('#sel-item-tag option:selected').text()
                   
            // This code is ment to prevent duplicates from being entered.
            var should_stop = false;
            $('input.item-tag').each( function(i,el) {
                var curr = $(el).data('tagid');
                if (tag_id === curr) {
                    should_stop = true;
                }
            });
            if (should_stop) {
                console.error("No duplicates allowed!");
                return;
            }

            if( $('#sel-item-tag').val() == null || $('#sel-item-tag').val() == '' ){
               console.error("No empty id values allowed");
            }
            else{

                var new_tag = '<tr style="display:none;"><td>' +
                '<input data-tagid="'+tag_id+'" type="text" class="item-tag form-control" name="item-tag[]" readonly value="' + name + '" />' +
                    '</td><td>' +
                    '<button type="button" role="button" class="btn btn-danger"><em class="section-button fa fa-remove"></em></button></td></tr>';
                $(this).parentsUntil('table').find('tr:last').after(new_tag);
                $(this).parentsUntil('table').find('tr:last').fadeIn(1000);
                $(this).parentsUntil('tbody').find('select.item-tag option:selected').attr('disabled','true');
                $('input.item-tag').each(function(int, el){ console.debug( $(el).data('tagid') ); });
                $('#sel-item-tag').val('');
            }
        });
                      
        // When the 'Remove' button was selected for a tag row.
        $('body').on('click', '.item-tag-table button.btn-danger', function(){
            var tag = $(this).parentsUntil('tbody').find('input.item-tag').val();
            $('select.add-item-tag').find('option').each(function(){
            if( $(this).text() == tag )
                $(this).removeAttr('disabled');
            });
            $(this).parentsUntil('tbody').fadeOut(1000).detach().remove();
            $('.item-tag').each(function(int, el){ console.debug( $(el).data('tagid') ); });
        });
                      
                      
        // Get the latest table data when this page loads up first.
        ajax_refresh_table({{ issue.issue_id }});
    });
    
    
    /**
     *  Function will take all the tags in Product and populate the tags table.
     */
    function ajax_populate_tags() {
    var new_tag = '';

    {% if product_form.instance.product_id > 0 %}
    {% for tag in product_form.instance.tags.all %}
        var tag_id = {{ tag.tag_id }};
        var tag_name = '{{ tag.name }}';
        console.log(tag_id + " "+ tag_name);

        new_tag = '<tr style="display:none;"><td>' +
                  '<input data-tagid=" ' + tag_id + '" type="text" class="item-tag form-control" name="item-tag[]" readonly value="' + tag_name + '" />' +
                   '</td><td>' +
                   '<button type="button" role="button" class="btn btn-danger"><em class="section-button fa fa-remove"></em></button></td></tr>';

        $('#item-tag-table').find('tr:last').after(new_tag);
        $('#item-tag-table').find('tr:last').fadeIn(1000);
        $('#item-tag-table tbody').find('select.item-tag option:selected').attr('disabled','true');

    {% endfor %}
    {% endif %}
    }


    /**
     *  Function will asynchronously upload the cover image.
     */
    function ajax_upload_image() {
        if ($('#id_image').val() == "") {
            alert('Please select an image to upload');
            return false;
        }
        
        // Extract the information.
        var image = document.getElementById('id_image').files[0];
        var upload_id = $('#id_hidden_upload_id').val();
        
        // Insert or Update.
        set_imageupload(upload_id, false, image, 0, function(json_result) {
            $('#logo-image').attr('src', json_result['image']);
            $('#id_hidden_url').val(json_result['image']);
            $('#id_hidden_upload_id').val(json_result['upload_id']);
        });
    }


    /**
     *  Function will run the inserter function multiple times depending on
     *  the 'quantity' selected.
     */
    function ajax_add_items()
    {
        var quantity = $('#txt-quantity').val();
        for (var i = 0; i < quantity; i++)
        {
            ajax_set_data();
        }
    }

    /**
     *  Function will either insert / update the Product, Comic, and ImageUpload
     *  tables.
     */
    function ajax_set_data() {
        var issue_id = {{ issue.issue_id }}
        
        // DEFENSIVE CODE.
        if ($('#id_age').val() == '') {
            alert("Please select comic age");
            console.error("Please select comic age");
            return;
        }
        if ($('#id_store').val() == '') {
            alert("Please select store");
            console.error("Please select store");
            return;
        }
        if ($('#id_section').val() == '') {
            alert("Please select section");
            console.error("Please select section");
            return;
        }
        if ($('#id_category').val() == '') {
            alert("Please select Category");
            console.error("Please select category");
            return;
        }
        
        var tags = Array()
        $('input.item-tag').each( function(i,el) {
            tags.push( parseInt( $(el).data('tagid') ) );
        });
        
        // Insert/Update "product" model.
        var arr = {
            'name': '{{ issue.series.name }} ' + 'Issue #{{ issue.number }}',
            'type': '1',
            'is_sold': false,
            'sub_price': 0,
            'discount': 0,
            'discount_type': 1,
            'price': 0,
            'cost': 0,
            'organization': {{ org.org_id }},
            'store': parseInt( $('#id_store').val() ),
            'section': parseInt( $('#id_section').val() ),
            'receipt': '',
            'brand': parseInt( {{ brand.brand_id }} ),
            'is_available': false,
            'tags': tags,
            'category': parseInt( $('#id_category').val() ),
        };
        
        var upload_id = $('#id_hidden_upload_id').val();
        if (upload_id > 0) { // Add in Image seperately if one was uploaded.
            arr['image'] = parseInt( upload_id );
            arr['image_url'] =  $('#id_hidden_url').val();
        }        
        
    {% if product_form.instance.product_id > 0 %}
        // If we are editing a product, then we need to add in the product_id
        // so the javascript function will know to make an 'update' call and
        // not a 'insert' call.
        arr['product_id'] = {{ product_form.instance.product_id }}
    {% endif %}

        set_product(arr, function(json_result) {
            // Extract the 'product_id' and use it to tie it to the
            // 'comic' model.
            var product_id = json_result['product_id'];
                    
            var data = {
                'product': parseInt(product_id),
                'issue': parseInt(issue_id),
                'age': $('#id_age').val(),
                'type': 1,
                'store': $('#id_store').val(),
                'section': $('#id_section').val(),
                'price': $('#id_price').val(),
                'cost': $('#id_cost').val(),
                'is_cgc_rated': $('#id_is_cgc_rated').is(':checked'),
                'label_colour': label_colour,
                'cgc_rating': cgc_rating,
                'condition_rating': condition_rating,
                'is_canadian_priced_variant': $('#id_is_canadian_priced_variant').is(':checked'),
                'is_variant_cover': $('#id_is_variant_cover').is(':checked'),
                'is_retail_incentive_variant': $('#id_is_retail_incentive_variant').is(':checked'),
                'is_newsstand_edition': $('#id_is_newsstand_edition').is(':checked'),
            };
                 
            if (upload_id > 0) { // Add in Image seperately if one was uploaded.
                    data['upload_id'] = upload_id;
            }
                    
            var label_colour = $('#id_label_colour').val();
            if (label_colour != '') {
                data['label_colour'] = label_colour;
            }
            var cgc_rating = $('#id_cgc_rating').val();
            if (cgc_rating != '') {
                data['cgc_rating'] = cgc_rating;
            }
            var condition_rating = $('#id_condition_rating').val();
            if (condition_rating != '') {
                data['condition_rating'] = condition_rating;
            }
                    
        {% if comic_form.instance.comic_id > 0 %}
            // If we are editing a comic, then we need to add in the comic_id
            // so the javascript function will know to make an 'update' call and
            // not a 'insert' call.
            arr['comic_id'] = {{ comic_form.instance.comic_id }}
        {% endif %}
                    
            set_comic(data, function(json_result) {
                // If we've uploaded an image then we need to attach it and then
                // launch the edit page, else if we did not upload anything then
                // just launch the edit page immediately.
                if (upload_id > 0) {
                    // Let our upload image know it is properly assigned.
                    set_imageupload(upload_id, true, null, {{ employee.user_id }}, function(json_result) {
                        // Load up the 'Edit' controller associated with comics.
                        window.location = "/inventory/{{ org.org_id }}/{{ store.store_id }}/comic/"+issue_id+"/product/"+product_id;
                    }); // end imageupload
                } else {
                    window.location = "/inventory/{{ org.org_id }}/{{ store.store_id }}/comic/"+issue_id+"/product/"+product_id;
                }
            }); // end comic
        }); // end product
    }


    function ajax_load_section_dropdown(store_id)
    {
        list_sections({{ org.org_id }}, store_id, function(json_result) {
            var dropdown_html = '<select class="form-control" id="id_section" name="section">';
            $(json_result).each(function(iter,val2){
                var position_index = 0;
                $(val2['results']).each(function(iter2,val){
                    var section_id = val['section_id'];
                    var name = val['name'];
                    dropdown_html += '<option value="'+section_id+'">'+name+'</option>'
                    //<option value="" selected="selected">---------</option>
                    //<option value="1">Main Store</option>
                });
            })
            dropdown_html += '</select>';
                      
            // Save the new dropdown box to the existing UI.
            $('#id_section_placeholder').html(dropdown_html);
        });
    }


    function ajax_refresh_table(issue_id)
    {
        list_comics_by(issue_id, function(json_result) {
            generate_table(json_result);
        });
    }


    function generate_table(json_result)
    {
        // Debugging code
        //var json_text = JSON.stringify(json_result, null, 2);
        //var obj = JSON.parse(json_text);
        //console.log(obj)
    
        // Initial Code
        var html = '';
        html += '<table id="added-items-table" class="table table-condensed table-striped table-hover inventory-details">';
        html += '<thead>';
        html += '<tr>';
        html += '<th>Product #</th>';
        html += '<th>CGC Rated</th>';
        html += '<th>Label Colour</th>';
        html += '<th>Condition</th>';
        html += '<th></th>';
        html += '</tr>';
        html += '</thead>';
        html += '<tbody>';
    
        $(json_result).each(function(iter,val2){
            var position_index = 0;
            $(val2['results']).each(function(iter2,val){
                var issue_id = val['issue'];
                var product_id = val['product'];
                var comic_id = val['comic_id'];
                position_index += 1;
                html += '<tr>';
                html += '<td>' + product_id + '</td>';
                
                // Is CGC Rated
                html += '<td class="text-center">';
                if (val['is_cgc_rated']) {
                    html += 'Yes';
                } else {
                    html += 'No';
                }
                html += '</td>';
                                    
                // Label Colour
                html += '<td class="text-center">';
                if (val['is_cgc_rated']) {
                    html += val['label_colour'];
                                    
                } else {
                    html += '-';
                }
                html += '</td>';
                                    
                // Condition
                html += '<td class="text-center">';
                if (val['is_cgc_rated']) {
                    var percent = 10 * val['cgc_rating'];
                    html += '<div data-label="'+percent+'%" class="radial-bar radial-bar-'+percent+' radial-bar-sm"></div>';
                                    
                } else {
                    // Convert to 100/100
                    var percent = 10 * val['condition_rating'];
                    html += '<div data-label="'+percent+'%" class="radial-bar radial-bar-'+percent+' radial-bar-sm"></div>';
                }
                html += '</td>';
                                    
                
                // Edit / Delete
                html += '<td>';
                                    
                var onclick1 = 'onclick="window.location=\'/inventory/{{ org.org_id }}/{{ store.store_id }}/comic/'+issue_id+'/product/'+product_id+'\';"';
                html += '<a '+onclick1+' class="edit-item pr10 curp" data-toggle="tooltip" data-original-title="Edit Item" data-placement="top"><em class="fa fa-2x fa-edit"></em></a>';
                                    
                var onclick2 = 'ajax_delete('+comic_id+','+product_id+');';
                html += '<a onclick="'+onclick2+'" class="remove-item curp" data-toggle="tooltip" data-original-title="Remove Item" data-placement="top"><em class="fa fa-2x fa-remove"></em></a>';
                html += '</td>';
                                    
                html += '</tr>';
            });
        });
        
        html += '</tbody>';
        html += '</table>';
        $('#id_table_placeholder').html(''); // Clear Table
        $(html).appendTo('#id_table_placeholder'); // Load Table.
    }


    function ajax_delete(comic_id, product_id)
    {
        delete_comic(comic_id, function(json_result) {
            // Do nothing.
        });
        delete_product(product_id, function(json_result) {
            ajax_refresh_table({{ issue.issue_id }}); // Refresh table.
        });
    }


</script>