<!-- this is mainly for data that needs to be loaded when the page is loaded -->
<script>
    //-------------------------------------//
    // Fix jQuery CSFR Code Issue - 1 of 2 //
    //-------------------------------------//
    // Note: https://docs.djangoproject.com/en/1.8/ref/csrf/
    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    $(document).ready(function () {
        //-------------------------------------//
        // Fix jQuery CSFR Code Issue - 2 of 2 //
        //-------------------------------------//
        // Note: https://docs.djangoproject.com/en/1.8/ref/csrf/
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                }
            }
        });
                      
        ajax_refresh_table(); // Refresh the table for the first time.
              
        // The following code will poll the server every 10 seconds to see if
        // we have the latest data.
        //window.setInterval(function(){
        //    ajax_refresh_table();
        //}, 5000);
                      
                $('body').on('click', '.list-group.group-header', function () {
                        if ($(this).next().is(':visible')) {
                        $(this).next().slideUp();
                                $(this).find('.fa-caret-up').removeClass('fa-caret-up').addClass('fa-caret-down');
                        }
                        else {
                            $(this).next().slideDown();
                            $(this).find('.fa-caret-down').removeClass('fa-caret-down').addClass('fa-caret-up');
                        }
                    });
                
                });
    
    /**
     *  Makes a JSON call to our API service to fetch all the open cart sessions
     *  we have under this employee.
     */
    function ajax_refresh_table() {
        //////////
        // LIST //
        //////////
        var url = "/api/receipts/?has_finished=True";
        jQuery.ajax({
            url: url,
            cache: false,
            contentType: false,
            processData: false,
            type: 'GET',
            success: function(result){
                // Take the JSON results and generate a HTML table from it.
                generate_table(result);
            },
            error: function(xhr,status,error) {
                console.debug(status + ': ' + error + ' -- ' + xhr.responseText);
                alert(xhr.responseText);
            },
            complete: function(xhr,status) {
                
            }
        });
    }

    /**
     *  Renders a table listing all the open cart sessions in our system.
     */
    function generate_table(result)
    {
        // Debugging code
        //var json_text = JSON.stringify(result, null, 2);
        //var obj = JSON.parse(json_text);
    
        var html = '<table class="table">';
        html += '<thead>';
        html += '<tr>';
        html += '<th style="width:10%">Receipt #</th>';
        html += '<th style="width:15%;">Customer Name</th>';
        html += '<th style="width:15%;">Email</th>';
        html += '<th style="width:20%;">Date</th>';
        html += '<th style="width:10%;"># Items</th>';
        html += '<th style="width:10%;">Status</th>';
        html += '<th style="width:10%;">Details</th>';
        html += '</tr>';
        html += '</thead>';
        html += '<tbody>';
        
        $(result).each(function(iter,val){
            var receipt_id = val['receipt_id'];
            var url = "/inventory/{{ org.org_id }}/{{ store.store_id }}/orders/" + receipt_id +"/";
            html += '<tr>';
            html += '<td>' + receipt_id + '</td>';
            html += '<td>' + val['billing_first_name'] + ' ' + val['billing_last_name'] + '</td>';
            html += '<td>' + val['billing_email'] + '</td>';
            html += '<td>' + val['last_updated'] + '</td>';
            html += '<td>' + val['products'].length; + '</td>';
            
            var status = val['status'];
            html += '<td>';
            if (status == 1) // New Order
            {
                html += '<div class="label label-danger">New Order</div>';
            }
            else if (status == 2) // Picked
            {
                html += '<div class="label label-warning">Picked</div>';
            }
            else if (status == 3) // Shipped
            {
                html += '<div class="label label-primary">Shipped</div>';
            }
            else if (status == 4) // Received
            {
                html += '<div class="label label-success">Received</div>';
            }
            else if (status == 5) // In-Store Sale
            {
                html += '<div class="label label-info">In-store Sale</div>';
            }
            else if (status == 6) // Online Sale
            {
                html += '<div class="label label-info">Online Sale</div>';
            }
            html += '</td>';;
                       
            html += '<td>' + '<a href="' + url + '" class="btn btn-success btn-sm">View Details</a>' + '</td>';
            html += '</tr>';
        });
        html += '</tbody></table></div>';
        $('#id_table_placeholder').html(''); // Clear Table
        $(html).appendTo('#id_table_placeholder'); // Load Table.
    }
</script>