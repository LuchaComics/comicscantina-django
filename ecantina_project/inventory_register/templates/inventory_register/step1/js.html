{% load staticfiles %}
{% include 'api/organization.html' %}
{% include 'api/store.html' %}
{% include 'api/employee.html' %}
{% include 'api/customer.html' %}
{% include 'api/subdomain.html' %}
{% include 'api/common_js.html' %}
{% include 'store_base/receipt_js.html' %}
<script>
    //-------------------------------------//
    // Fix jQuery CSFR Code Issue - 1 of 2 //
    //-------------------------------------//
    // Note: https://docs.djangoproject.com/en/1.8/ref/csrf/
    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    $(document).ready(function () {
        //-------------------------------------//
        // Fix jQuery CSFR Code Issue - 2 of 2 //
        //-------------------------------------//
        // Note: https://docs.djangoproject.com/en/1.8/ref/csrf/
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                }
            }
        });
                      
        {% if employee %}
            window.location = "/inventory/register/step2";
        {% endif %}
    });


    function ajax_proceed_next()
    {
        create_org(function(organization) {
            create_owner(organization, function(owner) {
                create_subdomain(organization, null, function(ok) {
                    create_store(organization, function(store) {
                        create_subdomain(organization, store, function(ok2) {
                            window.location = "/inventory/register/step2";
                        });
                    });
                });
            });
        });
    }

    function create_org(callback)
    {
        var data = {
            'administrator': {{ user.id }},
            'email': "{{ org.email | escape | safe }}",
            //'logo': parseInt( {{ org.logo_id }} ),
            'name': "Comics Cantina",
            'description': "",
            'phone': "{{ customer.billing_phone | escape | safe }}",
            'street_number': "{{ customer.billing_street_number | escape | safe }}",
            'street_name': "{{ customer.billing_street_name | escape | safe }}",
            'unit_number': "{{ customer.billing_unit_number | escape | safe }}",
            'city': "{{ customer.billing_city | escape | safe }}",
            'country': "{{ customer.billing_country | escape | safe }}",
            'province': "{{ customer.billing_province | escape | safe }}",
            'postal': "{{ customer.billing_postal | escape | safe }}",
            'paypal_email': "{{ customer.email | escape | safe }}",
            'email': "{{ customer.email | escape | safe }}",
        };
        
        set_organization(
            data,
            function(success_json) {
                callback(success_json); // Return newly created organization.
            },
            function(failure_json) {
                console.log(failure_json);
            }
        );
    }

    function create_owner(organization, callback) {
        // Create a new owner employee.
        var data = {
            'user': {{ user.id }},
            'organization': organization['org_id'],
            'role': 1, // AKA "Owner".
            'is_tos_signed': true,
            'is_suspended': false,
            // 'profile': upload_id,
        };
        set_employee(
            data,
            function(success_json) {
                callback(success_json); // Return the newly created employee.
            },
            function(failure_json) {
                console.log(failure_json);
            }
        );
    }

    function create_store(organization, callback)
    {
        var data = {
            'organization': organization['org_id'],
            'administrator': {{ user.id }},
            'email': "{{ org.email | escape | safe }}",
            //'logo': parseInt( {{ org.logo_id }} ),
            'name': "Comics Cantina Store",
            'description': "",
            'phone': "{{ customer.billing_phone | escape | safe }}",
            'street_number': "{{ customer.billing_street_number | escape | safe }}",
            'street_name': "{{ customer.billing_street_name | escape | safe }}",
            'unit_number': "{{ customer.billing_unit_number | escape | safe }}",
            'city': "{{ customer.billing_city | escape | safe }}",
            'country': "{{ customer.billing_country | escape | safe }}",
            'province': "{{ customer.billing_province | escape | safe }}",
            'postal': "{{ customer.billing_postal | escape | safe }}",
            'paypal_email': "{{ customer.email | escape | safe }}",
            'email': "{{ customer.email | escape | safe }}",
        };
    
        set_store(
            data,
            function(success_json) {
                callback(success_json); // Return newly created organization.
            },
            function(failure_json) {
                console.log(failure_json);
            }
        );
    }

    function create_subdomain(organization, store, callback) {
        var data = null;
        
        if (store != null) {
            data = {
                'organization': organization['org_id'],
                'store': store['store_id'],
            };
        } else {
            data = {
                'organization': organization['org_id'],
            };
        }
        
        set_subdomain(
            data,
            function(success_json) {
                callback(success_json); // Return the newly created employee.
            },
            function(failure_json) {
                console.log(failure_json);
            }
        );
    }

</script>