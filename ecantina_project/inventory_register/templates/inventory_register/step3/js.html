{% load staticfiles %}
{% include 'api/organization.html' %}
{% include 'api/store.html' %}
{% include 'api/employee.html' %}
{% include 'api/customer.html' %}
{% include 'api/common_js.html' %}
{% include 'store_base/receipt_js.html' %}
<script>
    //-------------------------------------//
    // Fix jQuery CSFR Code Issue - 1 of 2 //
    //-------------------------------------//
    // Note: https://docs.djangoproject.com/en/1.8/ref/csrf/
    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    $(document).ready(function () {
        //-------------------------------------//
        // Fix jQuery CSFR Code Issue - 2 of 2 //
        //-------------------------------------//
        // Note: https://docs.djangoproject.com/en/1.8/ref/csrf/
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                }
            }
        });
    });


    function ajax_proceed_next()
    {
        // Get the store_id of this store.
        var store_id = parseInt({{ this_store.store_id }});
        if (isNaN(store_id)) {
            ajax_add_store(function(json_results) { // Create our store for the very first time.
                console.log(json_results);
                // window.location = "/inventory/register/step3";
            });
        } else { // Update our store.
           //TODO: Implement.
        }
    }

    function ajax_add_store(callback) {
        var data = {
            // Store
            'organization': '{{ org.org_id }}',
            'joined': $('#id_joined').val(),
            'email': $('#id_email').val(),
            'logo': $('#id_hidden_upload_id').val(),
            'name': $('#id_name').val(),
            'description': $('#id_description').val(),
            'website': $('#id_website').val(),
            'twitter_url': $('#id_twitter_url').val(),
            'facebook_url': $('#id_facebook_url').val(),
            'instagram_url': $('#id_instagram_url').val(),
            'linkedin_url': $('#id_linkedin_url').val(),
            'github_url': $('#id_github_url').val(),
            'google_url': $('#id_google_url').val(),
            'youtube_url': $('#id_youtube_url').val(),
            'flickr_url': $('#id_flickr_url').val(),
            'street_number': $('#id_street_number').val(),
            'street_name': $('#id_street_name').val(),
            'unit_number': $('#id_unit_number').val(),
            'city': $('#id_city').val(),
            'country': $('#id_country').val(),
            'province': $('#id_province').val(),
            'postal': $('#id_postal').val(),
            // Store Hours
            'monday_to': $('#id_monday_to').val(),
            'monday_from': $('#id_monday_from').val(),
            'tuesday_to': $('#id_tuesday_to').val(),
            'tuesday_from': $('#id_tuesday_from').val(),
            'wednesday_to': $('#id_wednesday_to').val(),
            'wednesday_from': $('#id_wednesday_from').val(),
            'thursday_to': $('#id_thursday_to').val(),
            'thursday_from': $('#id_thursday_from').val(),
            'friday_to': $('#id_friday_to').val(),
            'friday_from': $('#id_friday_from').val(),
            'saturday_to': $('#id_saturday_to').val(),
            'saturday_from': $('#id_saturday_from').val(),
            'sunday_to': $('#id_sunday_to').val(),
            'sunday_from': $('#id_sunday_from').val(),
            'is_open_monday': $('#id_is_open_monday').is(':checked'),
            'is_open_tuesday': $('#id_is_open_tuesday').is(':checked'),
            'is_open_wednesday': $('#id_is_open_wednesday').is(':checked'),
            'is_open_thursday': $('#id_is_open_thursday').is(':checked'),
            'is_open_friday': $('#id_is_open_friday').is(':checked'),
            'is_open_saturday': $('#id_is_open_saturday').is(':checked'),
            'is_open_sunday': $('#id_is_open_sunday').is(':checked'),
            // Other
            'is_aggregated': $('#id_is_aggregated').is(':checked'),
            'currency': $('#id_currency').val(),
            'language': $('#id_language').val(),
            'tax_rate': $('#id_tax_rate').val(),
            'is_comics_vendor': $('#id_is_comics_vendor').is(':checked'),
            'is_furniture_vendor': $('#id_is_furniture_vendor').is(':checked'),
            'is_coins_vendor': $('#id_is_coins_vendor').is(':checked'),
            'paypal_email': $('#id_paypal_email').val(),
        }
    
        if ($('#id_phone').val().length > 0) { // Add telephone if added.
            data['phone'] = get_phone('#id_phone');
        } else {
            data['phone'] = "";
        }
        if ($('#id_fax').val().length > 0) { // Add fax if added.
            data['fax'] = get_phone('#id_fax');
        } else {
            data['fax'] = "";
        }
    
        // Send the "FormData" object to be sent through REST and get updated.
        set_store(
            data,
            function(success_json) {
                callback(success_json);
            },
            function(error_json) {
                print_error(error_json);
            }
        );
    }

    /**
     * Prints a error box with the contents of the errors received from the server.
     */
    function print_error(error_json)
    {
        $('#error_box').prop("hidden", false); // Display error box.
        var message = "<b>Error(s):</b><hr/>";
        for (var key in error_json) {
            if (error_json.hasOwnProperty(key)) { // this will check if key is owned by data object and not by any of it's ancestors
                message += "<p>" + key + ": " + error_json[key] + "<p>";
            }
        }
        $('#error_box').html(message); // Replace the error string with the contents of the error box.
    }

</script>