{% load staticfiles %}
{% include 'api/organization.html' %}
{% include 'api/customer.html' %}
{% include 'api/receipt.html' %}
{% include 'api/common_js.html' %}
{% include 'store_base/receipt_js.html' %}
<script>
    var mySwiper = new Swiper('.swiper-container', {
        pagination: '.box-pagination',
        keyboardControl: true,
        paginationClickable: true,
        slidesPerView: 'auto',
        autoResize: true,
        resizeReInit: true,
    })

    $('.prevControl').on('click', function (e) {
        e.preventDefault()
        mySwiper.swipePrev()
    })
    $('.nextControl').on('click', function (e) {
        e.preventDefault()
        mySwiper.swipeNext()
    })
    
    /**
     * Prints a error box with the contents of the errors received from the server.
     */
    function print_error(new_message)
    {
    $('#error_box').prop("hidden", false);
    var message = "<b>Error(s):</b> "+new_message+"";
    $('#error_box').html(message);
    }

    function ajax_update_shipping_and_proceed_next()
    {
        get_receipt({{ receipt.receipt_id }}, function(receipt) {
            if (receipt['has_error']) {
                // Print error depending on system error.
                var error_code = receipt['error']
                if (error_code == 1) {
                    print_error("Cancellation online order detected. Contact administration.");
                } else if (error_code == 2) {
                    print_error("Currently we don't support shipping to your country.");
                } else {
                    print_error("Unknown error detected, please contact administration.");
                }
            } else {
                // Proceed further next and update.
                ajax_update_addendum();
            }
        });
    }

    function ajax_update_addendum()
    {
        get_customer({{ customer.customer_id }}, function(customer) {
            customer['shipping_street_number'] = $('#id_shipping_street_number').val();
            customer['shipping_street_name'] = $('#id_shipping_street_name').val();
            customer['shipping_unit_number'] = $('#id_shipping_unit_number').val();
            customer['shipping_city'] = $('#id_shipping_city').val();
            customer['shipping_country'] = $('#id_shipping_country').val();
            customer['shipping_province'] = $('#id_shipping_province').val();
            customer['shipping_postal'] = $('#id_shipping_postal').val();
                                 
            if ($('#id_shipping_phone').val().length > 0) { // Add telephone if added.
                customer['shipping_phone'] = get_phone('#id_shipping_phone');
            } else {
                customer['shipping_phone'] = "";
            }
                     
            set_customer(
                customer,
                function(success_json) { // Create a new customer
                    window.location = '/checkout/billing';
                },
                function(error_json) {
                    for (var key in error_json) {
                        // this will check if key is owned by data object and not by any of it's ancestors
                        if (error_json.hasOwnProperty(key)) {
                            $.notify( (key+': '+error_json[key]), "danger");
                        }
                    }
                }
            ); // End Set Customer
        }); // End Get Customer
    }
</script>