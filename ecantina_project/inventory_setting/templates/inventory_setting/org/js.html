{% include 'api/imageupload.html' %}
{% include 'api/organization.html' %}
{% include 'api/common_js.html' %}
<!-- this is mainly for data that needs to be loaded when the page is loaded -->
<script>
    //-------------------------------------//
    // Fix jQuery CSFR Code Issue - 1 of 2 //
    //-------------------------------------//
    // Note: https://docs.djangoproject.com/en/1.8/ref/csrf/
    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    $(document).ready(function () {
        //-------------------------------------//
        // Fix jQuery CSFR Code Issue - 2 of 2 //
        //-------------------------------------//
        // Note: https://docs.djangoproject.com/en/1.8/ref/csrf/
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                }
            }
        });
    });

    // this is to upload the cover image
    function ajax_upload_image() {
        if ($('#id_image').val() == "") {
           alert('Please select an image to upload');
           return false;
        }
    
        // Extract the information.
        var image = document.getElementById('id_image').files[0];
        var upload_id = $('#id_hidden_upload_id').val();
    }

    function ajax_save() {
        // Create our existing customers list.
        var customers = [];
    {% for customer in org.customers.all %}
        customers.push(parseInt( {{ customer.customer_id }} ));
    {% endfor %}
    
        // Get the URL and format it so no errors will be returned by Python.
        var website = $('#id_website').val();
        if (website.indexOf("http") < 0) {
            website = 'http://' + website;
        }
        // However if nothing was enterd then don't add the URL.
        if (website.length < 8) {
            website = "";
        }
        
        var arr = {
            'customers': customers,
            'administrator': parseInt( {{ org.administrator_id }} ),
            'org_id': {{ org.org_id }},
            'email': $('#id_email').val(),
            'logo': $('#id_hidden_upload_id').val(),
            'name': $('#id_name').val(),
            'description': $('#id_description').val(),
            'phone': get_phone('#id_phone'),
             //'fax': get_phone('#id_fax'),
            'website': website,
            'twitter_url': $('#id_twitter_url').val(),
            'facebook_url': $('#id_facebook_url').val(),
            'instagram_url': '',
            'linkedin_url': '',
            'github_url': '',
            'google_url': '',
            'youtube_url': '',
            'flickr_url': '',
            'street_number': $('#id_street_number').val(),
            'street_name': $('#id_street_name').val(),
            'unit_number': $('#id_unit_number').val(),
            'city': $('#id_city').val(),
            'country': $('#id_country').val(),
            'province': $('#id_province').val(),
            'postal': $('#id_postal').val(),
            'currency': $('#id_currency').val(),
            'language': $('#id_language').val(),
        };
                
        // Send the "FormData" object to be sent through REST and get updated.
        set_organization(arr,
            function(success_json) {
                // (1) Add notification message of success.
                $(document).trigger("add-alerts",[{
                    'message': 'Organization was Successfully Updated',
                    'priority': 'success'
                }]);
                        
                // (2) Add count-down timer to reloading page/cache.
                setTimeout(function(){
                    location.reload(true); // Reload page with cache cleared.
                }, 1000)
                         
            }, // success
            function(error_json) {
                for (var key in error_json) {
                    // this will check if key is owned by data object and not by any of it's ancestors
                    if (error_json.hasOwnProperty(key)) {
                         // Display the error here.
                         $(document).trigger("add-alerts",[{
                            'message': (key+': '+error_json[key]),
                            'priority': 'error'
                        }]);
                    }
                }
            }
        );
    }
</script>