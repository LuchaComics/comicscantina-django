{% include 'api/promotion.html' %}
<!-- this is mainly for data that needs to be loaded when the page is loaded -->
<script>
    //-------------------------------------//
    // Fix jQuery CSFR Code Issue - 1 of 2 //
    //-------------------------------------//
    // Note: https://docs.djangoproject.com/en/1.8/ref/csrf/
    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    $(document).ready(function () {
        //-------------------------------------//
        // Fix jQuery CSFR Code Issue - 2 of 2 //
        //-------------------------------------//
        // Note: https://docs.djangoproject.com/en/1.8/ref/csrf/
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                }
            }
        });
                      
        /**
         *  The following section makes the 'promotions' automatically load
         *  when this page is refreshed or loaded.
         */
        ajax_refresh_table();
    });
    
    function generate_table(json_result)
    {
        // Debugging code
        //var json_text = JSON.stringify(result, null, 2);
        //var obj = JSON.parse(json_text);
        
        // Initial Code
        var html = '';
        html += '<div class="table-responsive">';
        html += '<table class="store-section-table table">';
        html += '<thead>';
        html += '<tr>';
        html += '<th>Promotion Name</th>';
        html += '<th style="width:35%;">Discount</th>';
        html += '<th>Add/Remove</th>';
        html += '</tr>';
        html += '</thead>';
        html += '<tbody>';
        
        // Add
        html += '<tr>';
        html += '<td>';
        html += '<input id="id_section_id_0" type="text" class="store-section form-control" name="store-section[]" placeholder="Enter section name">';
        html += '</td>';
        html += '<td>';
        html += '<div class="input-group"><input class="tag-discount form-control pull-left" style="width:36px;padding:5px;" name="tag-discount[]" type="text"><select class="tag-discount-type form-control pull-right" style="width:45px;padding:5px;" name="tag-discount-type[]"><option value="percent" selected="">%</option><option value="dollars">$</option></select></div>';
        html += '</td>';
        html += '<td>';
        html += '<button onclick="ajax_promotion(0);" id="id_section_name" ';
        html += 'type="button" class="btn btn-labeled btn-success btn-add"> ';
        html += '<span class="btn-label"><em class="fa fa-plus"></em></span><span style="font-size:12pt;">Add</span>';
        html += '</button>';
        html += '<tbody>';
        html += '</td>';
        html += '</tr>';
        
        $(json_result).each(function(iter,val){
            var promotion_id = val['promotion_id'];
            var name = val['name'];
            var store_id = val['store'];
            var org_id = val['organization'];
            var discount = val['discount'];
            var discount_type = val['discount_type'];
                            
            // Table Row
            html += '<tr>';
                            
            // Name
            var input = '<input id="id_section_id_' + promotion_id + '" ';
            input += 'onfocusout="alert("test");" ';
            input += 'type="text" ';
            input += 'class="store-section form-control" name="store-section[]" placeholder="Enter section name" ';
            input += 'value="' + name +'">';
            html += '<td>' + input + '</td>';
                   
            // Discount / Type
            var group = '<div class="input-group">';
            group += '<input class="tag-discount form-control ';
            group += 'pull-left" style="width:36px;padding:5px;" ';
            group += 'name="tag-discount[]" type="text" ';
            group += 'value="' + discount + '">';
            group += '<select class="tag-discount-type form-control pull-right" ';
            group += 'style="width:45px;padding:5px;" ';
            group += 'name="tag-discount-type[]">';
            if (discount_type == 1)
            {
                group += '<option value="percent" selected="">%</option>';
                group += '<option value="dollars">$</option>';
            }
            else if (discount_type == 2)
            {
                group += '<option value="percent">%</option>';
                group += '<option value="dollars" selected="">$</option>';
            }
            group += '</select>';
            group += '</div>';
            html += '<td>' + group + '</td>';
                            
            // Delete Button
            var del = '<button onclick="ajax_del_promotion(' + promotion_id + ');" ';
            del += 'type="button" role="button" class="btn btn-danger">';
            del += '<em class="section-button fa fa-remove"></em>';
            del += '</button>';
            html += '<td>' + del + '</td>';
                            
            // Close Table Row
            html += '</tr>';
        });
                            
        html += '</tbody></table></div>';
        $('#id_table_placeholder').html(''); // Clear Table
        $(html).appendTo('#id_table_placeholder'); // Load Table.
    }

    function ajax_refresh_table()
    {
        list_promotions({{ org.org_id }}, function(json_result) {
            generate_table(json_result);
        });
    }

    /**
     *  Function either adds or updates the section and then refreshes the table.
     */
    function ajax_promotion(promotion_id)
    {
        var name = $('#id_section_id_' + promotion_id).val();
    
        // Fetch the data from the view and encode it into a "FormData" object.
        var data = new FormData();
        if (promotion_id > 0) {
            data.append('promotion_id', promotion_id);
        }
        data.append('name', name);
        data.append('organization', {{ org.org_id }});
    
        // Insert / Update and then refresh table.
        set_promotion(promotion_id, data, function(json_result) {
            ajax_refresh_table();
        });
    }

    function ajax_del_promotion(promotion_id)
    {
        // Call function to delete the section.
        delete_promotion(promotion_id, function(json_result) {
            ajax_refresh_table();  // Reload the table.
        });
    }
</script>