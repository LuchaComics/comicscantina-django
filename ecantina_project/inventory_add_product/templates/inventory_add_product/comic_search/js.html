{% load staticfiles %}
{% include 'api/organization.html' %}
{% include 'api/series.html' %}
<!-- this is mainly for data that needs to be loaded when the page is loaded -->
<script>
    //-------------------------------------//
    // Fix jQuery CSFR Code Issue - 1 of 2 //
    //-------------------------------------//
    // Note: https://docs.djangoproject.com/en/1.8/ref/csrf/
    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    $(document).ready(function () {
        //-------------------------------------//
        // Fix jQuery CSFR Code Issue - 2 of 2 //
        //-------------------------------------//
        // Note: https://docs.djangoproject.com/en/1.8/ref/csrf/
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                }
            }
        });
                  
        // DYNAMIC SEARCHING (AKA AJAX SEARCHING)
        // The following code will provide all the necessary functions
        // which allow dynamic searching of comic books...
        //
        // Whenever user starts typing a textbox, start dynamically
        // making ajax calls to look up the results.
        var thread = null;
                      
        function lookupComics() {
            var series =  $('#id_series').val();
            var publisher =  $('#id_publisher').val();
            var language_id = 25;
            var country_id = 225;
            //var language =  $('#id_language').val();
            //var country =  $('#id_country').val();
            var from =  $('#id_from').val();
            var to =  $('#id_to').val();
                    
            // Call our application and return results.
            ajax_search_comics(series, publisher, from, to, language_id, country_id);
        }
                    
        // SERIES
        $('#id_series').keyup(function() {
            clearTimeout(thread);
            thread = setTimeout(function() { lookupComics(); }, 500);
        });
                    
        // PUBLISHER
        $('#id_publisher').keyup(function() {
            clearTimeout(thread);
            thread = setTimeout(function() { lookupComics(); }, 500);
        });
                      
        // FROM
        $('#id_from').keyup(function() {
            clearTimeout(thread);
            thread = setTimeout(function() { lookupComics(); }, 500);
        });
                      
        // TO
        $('#id_to').keyup(function() {
            clearTimeout(thread);
            thread = setTimeout(function() { lookupComics(); }, 500);
        });
                      
        // LANGUAGE
        $('#id_language').keyup(function() {
            clearTimeout(thread);
            thread = setTimeout(function() { lookupComics(); }, 500);
        });
                      
        // COUNTRY
        $('#id_country').keyup(function() {
            clearTimeout(thread);
            thread = setTimeout(function() { lookupComics(); }, 500);
        });
    });
                      
    function ajax_search_comics(series, publisher, min_year_began, max_year_ended, language, country)
    {
        var language_id = 1;
        var country_id = 1;
        filter_series(series, publisher, min_year_began, max_year_ended, language_id, country_id, function (json_result) {
            generate_table(json_result);
        });
        
    }

                  
    function ajax_refresh_table()
    {
        list_customers(function(json_result) {
            generate_table(json_result);
        });
    }

    function ajax_search()
    {
        var keyword = $('#id_search_keyword').val();
        search_customers(keyword, function(json_result) {
            generate_table(json_result);
        });
    }

function generate_table(json_result)
{
    // Debugging code
    //var json_text = JSON.stringify(json_result, null, 2);
    //var obj = JSON.parse(json_text);
    //console.log(obj)
    
    // Initial Code
    var html = '';
    html += '<div class="table-responsive" style="background-color:#fafafa;padding-left:20px;padding-right:20px;">';
    html += '<table class="table">';
    html += '<thead>';
    html += '<tr>';
    html += '<th>Series Name</th>';    // 1
    html += '<th>Publisher</th>';      // 2
    html += '<th>Date Published</th>'; // 3
    html += '<th></th>';               // 4
    html += '</tr>';
    html += '</thead>';
    html += '<tbody>';
    
    $(json_result).each(function(iter,val2){
                        $(val2['results']).each(function(iter2,val){
                                                var series_id = val['series_id'];
                                                if (val['name'] != "")
                                                {
                                                
                                                // Table Row
                                                html += '<tr>';
                                                
                                                // Col 1
                                                html += '<td>' + val['name'] + '</td>';
                                                
                                                // Col 2
                                                html += '<td>' + val['publisher_name'] + '</td>';
                                                
                                                // Col 3
                                                html += '<td>' + val['publication_dates'] + '</td>';
                                                
                                                // Col 4
                                                var onclick = 'ajax_new('+series_id+');';
                                                var col4 = '<button class="btn btn-sm btn-labeled btn-success pull-left mb mr mt-sm" onclick="'+onclick+'">';
                                                col4 += '<span class="btn-label"><i class="fa fa-plus"></i></span>Add Pull List';
                                                col4 += '</button>';
                                                html += '<td style="text-align:center;">' + col4 + '</td>';
                                                
                                                // Close Table Row
                                                html += '</tr>';
                                                }
                                                });
                        });
                        
                        html += '</tbody></table></div>';
                        $('#id_table_placeholder').html(''); // Clear Table
                        $(html).appendTo('#id_table_placeholder'); // Load Table.
}
</script>