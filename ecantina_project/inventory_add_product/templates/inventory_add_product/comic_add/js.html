{% load staticfiles %}
{% include 'api/section.html' %}
{% include 'api/comic.html' %}
{% include 'api/product.html' %}
<!-- this is mainly for data that needs to be loaded when the page is loaded -->
<script>
    //-------------------------------------//
    // Fix jQuery CSFR Code Issue - 1 of 2 //
    //-------------------------------------//
    // Note: https://docs.djangoproject.com/en/1.8/ref/csrf/
    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    $(document).ready(function () {
        //-------------------------------------//
        // Fix jQuery CSFR Code Issue - 2 of 2 //
        //-------------------------------------//
        // Note: https://docs.djangoproject.com/en/1.8/ref/csrf/
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                }
            }
        });
                      
        // Initialize the UI.
        $('#id_section').prop("disabled", true);
        $('#id_label_colour').prop("disabled", true);
        $('#id_cgc_rating_ui').hide();
                      
        // When the user clicks the 'Store', the 'Sections' will get filtered
        // down to the specific location.
        $('#id_store').on('change', function(){
            var store_id = $(this).val();
            if (store_id > 0)
            {
                $('#id_section').prop("disabled", false);
                ajax_load_section_dropdown(store_id);
            }
        });
                      
        // this changes the options available in the condition rating dropdown
        $('#id_is_cgc_rated').on('click', function(){
            if( $(this).is(':checked') ){
                //alert("Checked"); // Debugging Purposes Only
                $('#id_label_colour').prop("disabled", false);
                $('#id_cgc_rating_ui').show();
                $('#id_condition_rating_ui').hide();
            }
            else {
                //alert("unchecked"); // Debugging Purposes Only
                $('#id_label_colour').prop("disabled", true);
                $("#id_label_colour").val($("#target option:first").val());
                $("#id_condition_rating").val($("#target option:first").val());
                $('#id_condition_rating_ui').show();
                $('#id_cgc_rating_ui').hide();
            }
        });
                      
        // When the 'Add' button was selected for the tag.
        $('body').on('click', '.item-tag-table button.btn-success.btn-add', function(){
            // Extract these values from the tag.
            var tag_id = $('#sel-item-tag').val();
            var name = $('#sel-item-tag option:selected').text()
                     
            if( $(this).parentsUntil('tbody').find('select.add-item-tag').val() != "" ) {
                var new_tag = '<tr style="display:none;"><td>' +
                '<input data-tagid="'+tag_id+'" type="text" class="item-tag form-control" name="item-tag[]" readonly value="' + name + '" />' +
                    '</td><td>' +
                    '<button type="button" role="button" class="btn btn-danger"><em class="section-button fa fa-remove"></em></button></td></tr>';
                $(this).parentsUntil('table').find('tr:last').after(new_tag);
                $(this).parentsUntil('table').find('tr:last').fadeIn(1000);
                $(this).parentsUntil('tbody').find('select.item-tag option:selected').attr('disabled','true');
                $('.item-tag').each(function(int, el){ console.debug( $(el).data('tagid') ); });
            }
        });
                      
        // When the 'Remove' button was selected for a tag row.
        $('body').on('click', '.item-tag-table button.btn-danger', function(){
            var tag = $(this).parentsUntil('tbody').find('input.item-tag').val();
            $('select.add-item-tag').find('option').each(function(){
            if( $(this).text() == tag )
                $(this).removeAttr('disabled');
            });
            $(this).parentsUntil('tbody').fadeOut(1000).detach().remove();
            $('.item-tag').each(function(int, el){ console.debug( $(el).data('tagid') ); });
        });
    });
    
    function ajax_add_items(issue_id)
    {
        var upload_id = $('#id_hidden_upload_id').val();
        var quantity = $('#txt-quantity').val();
        for (var i = 0; i < quantity; i++)
        {
            ajax_add_item(issue_id, upload_id);
        }
        
    }

{% if product_form.instance.comic_id > 0 %}
   function ajax_edit_items(issue_id)
   {
       var upload_id = $('#id_hidden_upload_id').val();
       ajax_add_item(issue_id, upload_id);
       window.location='/inventory/{{ org.org_id }}/{{ store.store_id }}/add/comic/{{ issue.issue_id }}/product/0';
   }
{% endif %}

    function ajax_add_item(issue_id, upload_id) {        
        // DEFENSIVE CODE.
        if ($('#id_age').val() == '') {
            alert("Please select comic age");
            console.error("Please select comic age");
            return;
        }
        if ($('#id_store').val() == '') {
            alert("Please select store");
            console.error("Please select store");
            return;
        }
        if ($('#id_section').val() == '') {
            alert("Please select section");
            console.error("Please select section");
            return;
        }
        
        // Insert/Update "product" model.
        var arr = {
            'name': '{{ issue.series.name }} ' + 'Issue #{{ issue.number }}',
            'type': '1',
            'is_sold': false,
            'sub_price': 0,
            'discount': 0,
            'discount_type': '1',
            'price': 0,
            'cost': 0,
            'image': '',
            'organization': {{ org.org_id }},
            'store': $('#id_store').val(),
            'section': $('#id_section').val(),
            'receipt': '',
            'brand': {{ brand.brand_id }},
            'is_available': false,
        };
        set_product(arr, function(json_result) {
            // Extract the 'product_id' and use it to tie it to the
            // 'comic' model.
            var product_id = json_result['product_id'];
                    
            // Insert the comic.
            var data = {
                'product': parseInt(product_id),
                'issue': parseInt(issue_id),
                'age': $('#id_age').val(),
                'type': 1,
                'upload_id': upload_id,
                'store': $('#id_store').val(),
                'section': $('#id_section').val(),
                'price': $('#id_price').val(),
                'cost': $('#id_cost').val(),
                'is_cgc_rated': $('#id_is_cgc_rated').is(':checked'),
                'label_colour': label_colour,
                'cgc_rating': cgc_rating,
                'condition_rating': condition_rating,
                'is_canadian_priced_variant': $('#id_is_canadian_priced_variant').is(':checked'),
                'is_variant_cover': $('#id_is_variant_cover').is(':checked'),
                'is_retail_incentive_variant': $('#id_is_retail_incentive_variant').is(':checked'),
                'is_newsstand_edition': $('#id_is_newsstand_edition').is(':checked'),
            };
                    
            // Defensive Code: Only add items to the array that are selected
            //                 and not '-----' selected.
            var label_colour = $('#id_label_colour').val();
            if (label_colour != '') {
                data['label_colour'] = label_colour;
            }
            var cgc_rating = $('#id_cgc_rating').val();
            if (cgc_rating != '') {
                data['cgc_rating'] = cgc_rating;
            }
            var condition_rating = $('#id_condition_rating').val();
            if (condition_rating != '') {
                data['condition_rating'] = condition_rating;
            }
                    
            set_comic(data, function(json_result) {
                // Load up the 'Edit' controller associated with comics.
                window.location = "/inventory/{{ org.org_id }}/{{ store.store_id }}/add/comic/"+issue_id+"/product/"+product_id;
            });
                    
        });
    }

    function ajax_load_section_dropdown(store_id)
    {
        list_sections({{ org.org_id }}, store_id, function(json_result) {
            var dropdown_html = '<select class="form-control" id="id_section" name="section">';
            $(json_result).each(function(iter,val2){
                var position_index = 0;
                $(val2['results']).each(function(iter2,val){
                    var section_id = val['section_id'];
                    var name = val['name'];
                    dropdown_html += '<option value="'+section_id+'">'+name+'</option>'
                    //<option value="" selected="selected">---------</option>
                    //<option value="1">Main Store</option>
                });
            })
            dropdown_html += '</select>';
                      
            // Save the new dropdown box to the existing UI.
            $('#id_section_placeholder').html(dropdown_html);
        });
    }

</script>