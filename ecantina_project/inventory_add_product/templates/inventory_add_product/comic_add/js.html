{% load staticfiles %}
<script>
    $(document).ready(function(){
        // Initialize the UI.
        $('#id_section').prop("disabled", true);
        $('#id_label_colour').prop("disabled", true);
        $('#id_cgc_rating_ui').hide();
                
        return
                      
        // Get the latest table data when this page loads up first.
        ajax_refresh_table({{ issue.issue_id }});
        
        // When the user clicks the 'Store', the 'Sections' will get filtered
        // down to the specific location.
        $('#id_store').on('change', function(){
            var store_id = $(this).val();
            if (store_id > 0)
            {
                ajax_load_section_dropdown({{ issue.issue_id }}, store_id)
            }
        });
        
        // this changes the options available in the condition rating dropdown
        $('#id_is_cgc_rated').on('click', function(){
            if( $(this).is(':checked') ){
                //alert("Checked"); // Debugging Purposes Only
                $('#id_label_colour').prop("disabled", false);
                $('#id_cgc_rating_ui').show();
                $('#id_condition_rating_ui').hide();
            }
            else {
                //alert("unchecked"); // Debugging Purposes Only
                $('#id_label_colour').prop("disabled", true);
                $("#id_label_colour").val($("#target option:first").val());
                $("#id_condition_rating").val($("#target option:first").val());
                $('#id_condition_rating_ui').show();
                $('#id_cgc_rating_ui').hide();
            }
        });
    });
    
    function ajax_load_section_dropdown(issue_id, store_id)
    {
        var data = new FormData();
        data.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        jQuery.ajax({
            url: '/inventory/{{ org.org_id }}/{{ store.store_id }}/add/comic/'+issue_id+'/section_dropbox/'+store_id+'',
            data: data,
            cache: false,
            contentType: false,
            processData: false,
            type: 'POST',
            success: function(html_result){
                // Replace the code
                $('#id_section_placeholder').html(html_result);
            },
            error: function(xhr,status,error) {
            // error code here
                },
            complete: function(xhr,status) {
            // completion code here
            }
        });
    }

    // this is to upload the cover image
    function ajax_upload_image(issue_id) {
        var errors = 0;
        //alert('ajax_upload_logo_image()'); // Debugging Purposes.
    
        if ($('#id_image').val() == "") {
            alert('Please select an image to upload');
            errors++;
        }
    
        if (errors > 0) {
            return false;
        }
    
        // change this to the ajax function call in python
        var url = '/inventory/{{ org.org_id }}/{{ store.store_id }}/add/comic/'+issue_id+'/upload_cover';
    
        var data = new FormData();
        data.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        data.append('image', document.getElementById('id_image').files[0]);
        jQuery.ajax({
            url: url,
            data: data,
            cache: false,
            contentType: false,
            processData: false,
            type: 'POST',
            success: function(json_result){
                // If success then update the image, else display error.
                if (json_result.status == "success")
                {
                    $('#logo-image').attr('src', json_result.src);
                    $('#id_hidden_upload_id').val(json_result.id);
                }
                else
                {
                    alert(json_result.message);
                }
            },
            error: function(xhr,status,error) {
                console.debug(status + ': ' + error + ' -- ' + xhr.responseText);
            },
            complete: function(xhr,status) {
                
            }
        });
    }

    function ajax_add_items(issue_id)
    {
        var upload_id = $('#id_hidden_upload_id').val();
        var quantity = $('#txt-quantity').val();
        for (var i = 0; i < quantity; i++)
        {
            ajax_add_item(issue_id, upload_id);
        }
        
    }

{% if product_form.instance.comic_id > 0 %}
    function ajax_edit_items(issue_id)
    {
        var upload_id = $('#id_hidden_upload_id').val();
        ajax_add_item(issue_id, upload_id);
        window.location='/inventory/{{ org.org_id }}/{{ store.store_id }}/add/comic/{{ issue.issue_id }}/product/0';
    }
{% endif %}

    function ajax_add_item(issue_id, upload_id) {
        // change this to the ajax function call in python
        var url = '/inventory/{{ org.org_id }}/{{ store.store_id }}/add/comic/'+issue_id+'/add_product';
    
        var data = new FormData();
        data.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    {% if product_form.instance.comic_id > 0 %}
        data.append('comic_id', {{ product_form.instance.comic_id }});
        data.append('created', "{{ product_form.instance.created }}");
    {% else %}
        data.append('comic_id', '');
        data.append('created', get_date());
    {% endif %}
        data.append('age', $('#id_age').val());
        data.append('type', 1);
        data.append('upload_id', upload_id);
        data.append('store', $('#id_store').val());
        data.append('section', $('#id_section').val());
        data.append('price', $('#id_price').val());
        data.append('cost', $('#id_cost').val());
        data.append('is_cgc_rated', $('#id_is_cgc_rated').val());
        data.append('label_colour', $('#id_label_colour').val());
        data.append('cgc_rating', $('#id_cgc_rating').val());
        data.append('condition_rating', $('#id_condition_rating').val());
        data.append('is_canadian_priced_variant', $('#id_is_canadian_priced_variant').val());
        data.append('is_variant_cover', $('#id_is_variant_cover').val());
        data.append('is_retail_incentive_variant', $('#id_is_retail_incentive_variant').val());
        data.append('is_newsstand_edition', $('#id_is_newsstand_edition').val());
        
        jQuery.ajax({
            url: url,
            data: data,
            cache: false,
            contentType: false,
            processData: false,
            type: 'POST',
            success: function(json_result){
                // If success then update the image, else display error.
                if (json_result.status == "success")
                {
                    // alert("ok saved"); // Debugging Purposes
                    ajax_refresh_table(issue_id);
                }
                else
                {
                    alert(json_result.message);
                }
            },
            error: function(xhr,status,error) {
                console.debug(status + ': ' + error + ' -- ' + xhr.responseText);
            },
            complete: function(xhr,status) {
            
            }
        });
    }


    function ajax_refresh_table(issue_id)
    {
        var data = new FormData();
        data.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        jQuery.ajax({
            url: '/inventory/{{ org.org_id }}/{{ store.store_id }}/add/comic/'+issue_id+'/list_products',
                data: data,
                cache: false,
                contentType: false,
                processData: false,
                type: 'POST',
                success: function(html_result){
                    // Replace the code
                    $('#id_table_placeholder').html(html_result);
                },
                error: function(xhr,status,error) {
                    // error code here
                },
                complete: function(xhr,status) {
                    // completion code here
                }
        });
    }

    function ajax_delete_comic(issue_id, comic_id)
    {
        var data = new FormData();
        data.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        jQuery.ajax({
            url: '/inventory/{{ org.org_id }}/{{ store.store_id }}/add/comic/'+issue_id+'/delete/'+comic_id,
            data: data,
            cache: false,
            contentType: false,
            processData: false,
            type: 'POST',
            success: function(html_result){
                // Update Table.
                ajax_refresh_table(issue_id);
            },
            error: function(xhr,status,error) {
                // error code here
            },
            complete: function(xhr,status) {
                // completion code here
            }
        });
    }

    function get_date()
    {
        var today = new Date();
        var dd = today.getDate();
        var mm = today.getMonth()+1; //January is 0!
        var yyyy = today.getFullYear();
    
        if(dd<10) {
            dd='0'+dd
        }
    
        if(mm<10) {
            mm='0'+mm
        }
    
        today = yyyy+'-'+mm+'-'+dd;
        return today
    }
</script>