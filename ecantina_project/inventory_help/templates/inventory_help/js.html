<!-- Load API Handlers -->
{% include 'api/imageupload.html' %}

<script>
    //-------------------------------------//
    // Fix jQuery CSFR Code Issue - 1 of 2 //
    //-------------------------------------//
    // Note: https://docs.djangoproject.com/en/1.8/ref/csrf/
    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    $(document).ready(function () {
        //-------------------------------------//
        // Fix jQuery CSFR Code Issue - 2 of 2 //
        //-------------------------------------//
        // Note: https://docs.djangoproject.com/en/1.8/ref/csrf/
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                }
            }
        });
    });
                  
    /**
     *  Function will either upload a new image or update the existing
     *  one with the new image. Afterwards function will upad the UI
     *  to have a picture of the image that was uploaded and save the
     *  upload_id.
     */
    function ajax_upload_image() {
        if ($('#id_image').val() == "") {
            alert('Please select an image to upload');
            return false;
        }
        
        // Extract the information.
        var image = document.getElementById('id_image').files[0];
        var upload_id = $('#id_hidden_upload_id').val();
        
        // Process results...
        if (upload_id > 0)
        {
            // Upload the new image and render the page with the results.
            update_imageupload(upload_id, false, image, 0, function(json_result) {
                $('#logo-image').attr('src', json_result['image']);
                $('#id_hidden_upload_id').val(json_result['upload_id']);
            });
        }
        else
        {
            // Insert the new upload and then render the page with the results.
            insert_imageupload(false, image, 0, function(json_result) {
                $('#logo-image').attr('src', json_result['image']);
                $('#id_hidden_upload_id').val(json_result['upload_id']);
            });
        }
    }

    function ajax_save() {
        alert("OK");
        return;
        var url = '/inventory/{{ org.org_id }}/{{ store.store_id }}/help/save_data';
    
        var data = new FormData();
        // Store
        data.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        data.append('upload_id', $('#id_hidden_upload_id').val());
        data.append('subject', $('#id_subject').val());
        data.append('subject_url', $('#id_subject_url').val());
        data.append('message', $('#id_message').val());
    
        jQuery.ajax({
            url: url,
            data: data,
            cache: false,
            contentType: false,
            processData: false,
            type: 'POST',
            success: function(json_result){
                if (json_result.status == "success")
                {
                    //alert("ok saved"); // Debugging Purposes
                    alert("Help Request Submitted! Your ticket ID is #" + json_result.id + ". Thank you for your submission.");
                    window.location = '';
                }
                else
                {
                    alert(json_result.message);
                }
            },
            error: function(xhr,status,error) {
                console.debug(status + ': ' + error + ' -- ' + xhr.responseText);
            },
            complete: function(xhr,status) {
                
            }
        });
    }

</script>